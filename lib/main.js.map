{"version":3,"sources":["../src/main.ts"],"names":["createHandler","options","sourceBucket","sourceBucketName","sourcePrefix","cacheBucket","cacheBucketName","cachePrefix","storage","Storage","bucket","cacheControl","cacheControlInitial","mergedParams","params","Object","keys","reduce","acc","key","handleRequest","req","res","path","decodeURIComponent","source","target","transforms","sourceFile","file","createReadStream","decompress","on","noop","x","statusCode","set","headers","etag","pipe","end","stream","err","out","targetFile","createWriteStream","contentType","console","error","status","send","statusMessage","resume"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) 2020-present Kriasoft | MIT License (https://git.io/JUgVL)\n */\n\nimport { RequestHandler } from \"express\";\nimport { Storage } from \"@google-cloud/storage\";\n\nimport { params } from \"./params\";\nimport { parseUrlPath, parseBucket } from \"./parse\";\nimport { transform } from \"./transform\";\nimport { handleError, noop } from \"./utils\";\nimport type { Options, Params } from \"./types\";\nexport type { Options, Params } from \"./types\";\n\nexport function createHandler(options: Options): RequestHandler {\n  const [sourceBucketName, sourcePrefix] = parseBucket(options.sourceBucket);\n  const [cacheBucketName, cachePrefix] = parseBucket(options.cacheBucket);\n\n  const storage = new Storage(options.storage);\n  const sourceBucket = storage.bucket(sourceBucketName);\n  const cacheBucket = storage.bucket(cacheBucketName);\n\n  const cacheControl = \"public, max-age=31536000, immutable\";\n  const cacheControlInitial = \"public, max-age=31536000, s-maxage=0, immutable\";\n\n  const mergedParams = options.params\n    ? {\n        ...params,\n        ...Object.keys(options.params).reduce<Params>(\n          (acc, key) => ({\n            ...acc,\n            [key]: {\n              ...params[key as keyof Params],\n              ...options.params?.[key as keyof Params],\n            },\n          }),\n          {},\n        ),\n      }\n    : params;\n\n  return function handleRequest(req, res) {\n    const path = decodeURIComponent(req.path);\n    const { source, target, transforms } = parseUrlPath(path, mergedParams);\n\n    const sourceFile = target\n      ? cacheBucket.file(`${cachePrefix}${target}`)\n      : sourceBucket.file(`${sourcePrefix}${source}`);\n\n    sourceFile\n      .createReadStream({ decompress: false })\n      .on(\"error\", noop)\n      .on(\"response\", function (this: NodeJS.ReadStream, x) {\n        if (x.statusCode === 200) {\n          res.set(\"Content-Type\", x.headers[\"content-type\"]);\n          res.set(\"Cache-Control\", cacheControl);\n          res.set(\"etag\", x.headers.etag);\n          this.pipe(res);\n        } else if (x.statusCode === 404) {\n          this.end();\n          sourceBucket\n            .file(`${sourcePrefix}${source}`)\n            .createReadStream()\n            .on(\"error\", noop)\n            .on(\"response\", function (this: NodeJS.ReadStream, x) {\n              if (x.statusCode === 200) {\n                res.set(\"Cache-Control\", cacheControlInitial);\n                transform(this, transforms).stream((err, out) => {\n                  if (err) {\n                    handleError(res, err);\n                  } else {\n                    const targetFile = cacheBucket\n                      .file(`${cachePrefix}${target}`)\n                      .createWriteStream({\n                        contentType: x.headers[\"content-type\"],\n                      })\n                      .on(\"error\", (err) => {\n                        console.error(err);\n                      });\n                    out.pipe(targetFile);\n                    out.pipe(res);\n                  }\n                });\n              } else {\n                this.end(() => {\n                  res.status(x.statusCode);\n                  res.send(x.statusMessage);\n                });\n              }\n            })\n            .resume();\n        } else {\n          this.end(() => {\n            res.status(x.statusCode);\n            res.end(x.statusMessage);\n          });\n        }\n      })\n      .resume();\n  };\n}\n"],"file":"main.js"}